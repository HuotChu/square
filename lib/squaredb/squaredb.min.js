define(["./comparator"],function(t){"use strict";return function(n,e,r){var i,u,s,o=n[r],a=[],c=o.length;for(i in n)n.hasOwnProperty(i)&&a.push(i);if(u=o.reduce(function(t,n){var r;return"min"===e?r=n>t?t:n:"max"===e?r=t>n?t:n:("sum"===e||"avg"===e)&&(r=t+n),r}),"avg"===e)u/=c;else if("count"===e)return u=c*a.length,n={QUERY_COUNT:[u]};return a.length>1&&(s=t(n[r],"===",u),a.forEach(function(t){t!==r&&(i=n[t],n[t]=i.filter(function(t,n){return-1!==s.indexOf(n)}))})),n[r]=[u],n}}),define([],function(){"use strict";return function(t,n,e){var r,i,u,s,o="string"==typeof e?e.indexOf("."):-1,a="string"==typeof e?e.lastIndexOf("."):-1,c=0!==o,h=e.length&&a!==e.length-1,f=0,l=t.length,p=[];for(("like"===n||"not like"===n)&&(c&&(e="^"+e),h&&(e+="$")),f;l>f;++f)if(i=t[f]){switch(n){case"==":r=i==e;break;case"===":r=i===e;break;case">":r=i>e;break;case"<":r=e>i;break;case">=":r=i>=e;break;case"<=":r=e>=i;break;case"!=":r=i!=e;break;case"!==":r=i!==e;break;case"like":s=new RegExp(e,"i"),r=s.test(i);break;case"not like":s=new RegExp(e,"i"),r=!s.test(i);break;default:r=!1}u=p.indexOf(f)>-1,r&&!u&&p.push(f)}return p}}),define(["./go"],function(t){"use strict";var n=function(t){this.selects=t};n.prototype={db:void 0,distinct:!1,selects:[],table:void 0,where:void 0};var e=function(t,n,e,r){this._queryObject=t,t.where={initial:[n,e,r],and:[],or:[]}};e.prototype={and:function(t,n,e){return this._queryObject.where.and.push([t,n,e]),this},or:function(t,n,e){return this._queryObject.where.or.push([t,n,e]),this},go:function(){return t(this._queryObject)},GO:function(){return t(this._queryObject)}};var r=function(t,n,r){return new e(this._queryObject,t,n,r)},i=function(t,n){this._queryObject=t,this._table=t.db[n],t.table=this._table},u=function(t){return new i(this._queryObject,t)};i.prototype={_table:void 0,where:function(){return r.apply(this,arguments)},WHERE:function(){return r.apply(this,arguments)},go:function(){return t(this._queryObject)},GO:function(){return t(this._queryObject)}};var s=function(t){var e=this._queryObject.db;return this._queryObject=new n([t]),this._queryObject.distinct=t,this._queryObject.db=e,this},o=function(t,e){return this._queryObject=new n(e||"*"),this._queryObject.db=t,this};return o.prototype={_queryObject:{},from:function(){return u.apply(this,arguments)},FROM:function(){return u.apply(this,arguments)},distinct:function(){return s.apply(this,arguments)},DISTINCT:function(){return s.apply(this,arguments)}},o}),define(["./aggregates","./comparator"],function(t,n){"use strict";var e=function(e){var s,o,a,c,h,f,l,p,d,v,g,y,O,_,b,w,m=e,E=m.table,T=m.distinct,A=m.selects,I=m.where,j=A.length||1,q={},x={},R=function(){A=Object.keys(E),j=A.length,f=A[0]};for(d=0;j>d;++d)f=A[d],f=f.replace(/['"]/g,""),-1!==f.indexOf("(")&&(o=f.match(/^(\w+)\(([^\)]+)\)/),f=o[2],"*"===f&&R(),x[f]=o[1]),-1!==f.indexOf(" as ")&&(f=f.replace(/(^\w+)\sas\s\w+/,"$1")),"*"===f&&R(),l=E[f]||[],q[f]=l.filter(function(t){return null!==t});if(I){if(p=I.initial,_=I.or,y=I.and,a=n(E[p[0]],p[1],p[2]),_.length)for(d=0,j=_.length;j>d;++d)for(b=_[d],c=n(E[b[0]],b[1],b[2]),v=0,g=c.length;g>v;++v)w=c[v],-1===a.indexOf(w)&&a.push(w);if(y.length)for(d=0,j=y.length;j>d;++d)O=y[d],c=n(E[O[0]],O[1],O[2]),a=a.filter(function(t){return-1!==this.indexOf(t)}.bind(c));q=r(q,a)}T?(a=i(q[T]),h=r(q,a)):h=q;for(f in x)x.hasOwnProperty(f)&&(s=x[f],h=t(h,s,f));return h=u(h),s&&(h=h[0]),h},r=function(t,n){var e;for(e in t)t.hasOwnProperty(e)&&(t[e]=t[e].filter(function(t,e){return-1!==n.indexOf(e)}));return t},i=function(t){var n=[],e=[];return t.filter(function(t,r){return-1===n.indexOf(t)&&null!==t?(n.push(t),e.push(r),!0):void 0}),e},u=function(t){var n,e,r,i,u=[];for(n in t)if(t.hasOwnProperty(n))for(e=t[n],r=e.length,i=0;r>i;++i)u[i]||(u[i]={}),u[i][n]=e[i];return u};return e}),define(["../square","./comparator","./Select"],function(t,n,e){"use strict";var r=function(t,n){return this.__proto__={_db:t,_event:t._event+"."+n,constructor:this,columns:function(){var t,n=[];for(t in this)this.hasOwnProperty(t)&&n.push(t);return n},indices:function(){var t,n,e,r=[],i=0;for(n in this)if(this.hasOwnProperty(n)){for(t=this[n],e=t.length;e>i;++i)null!==t[i]&&r.push(i);return r}return r},holes:function(){var t,n,e,r=[],i=0;for(n in this)if(this.hasOwnProperty(n)){for(t=this[n],e=t.length;e>i;++i)null===t[i]&&r.push(i);return r}return r}},this},i=function(t,n){this._table=t,this._event=t._event+"."+n};i.prototype={constructor:i,_event:"",_db:void 0,push:function(t){return Array.prototype.push.call(this,t)},insert:function(t,n){var e=n in this;this[n]=t,e||void 0!==t&&null!==t||++this.length}},i.prototype.__proto__=Array.prototype;var u={},s=function(){var t=Array.from(arguments);return 1===t.length&&-1!==t[0].indexOf(",")&&(t=t[0].split(",").map(function(t){return t.trim()})),t},o=function(t,e,r,i){this.validIndices=n(t[e],r,i),this.AND=this.and=function(e,r,i){var u=n(t[e],r,i);return this.validIndices=this.validIndices.filter(function(t){return-1!==u.indexOf(t)}),this},this.OR=this.or=function(e,r,i){var u=[];return this.validIndices=this.validIndices.concat(n(t[e],r,i)),this.validIndices=this.validIndices.filter(function(t){return-1===u.indexOf(t)?(u.push(t),!0):void 0}),this}};u.__proto__={create:function(t){return this[t]=new a(t),this[t]},drop:function(t){return this[t]?(this[t]=null,delete this[t],!0):!1},get:function(t){return this[t]},show:function(){var t,n=[];for(t in this)this.hasOwnProperty(t)&&n.push(t);return n}};var a=function(t){this._event=t};return a.prototype={constructor:a,_event:"",_tableCount:0,count:function(){return this._tableCount},COUNT:function(){return this._tableCount},select:function(){var t=s.apply({},arguments);return new e(this,t)},SELECT:function(){return this.select.apply(this,arguments)},createTable:function(t){var n=this,e=new r(n,t);return n[t]=e,++n._tableCount,function(){var r=s.apply({},arguments);return r.length&&n.alterTable(t).add.apply({},arguments),e}},CREATE_TABLE:function(t){return this.createTable.call(this,t)},alterTable:function(t){var n=this[t];return{add:function(){var t,e,r=s.apply({},arguments),u=0,o=r.length,a=n.indices(),c=n.holes(),h=0,f=a.length;for(u;o>u;++u){for(t=r[u],e=n[t]=new i(n,t),h=0;f>h;++h)e.insert(void 0,a[h]);for(f=c.length,h=0;f>h;++h)e.insert(null,c[h])}return n},ADD:function(){return this.add.apply(this,arguments)},drop:function(){var t,e,r=s.apply({},arguments),i=0;for((0===r.length||"*"===r[0])&&(r=n.columns()),e=r.length;e>i;++i)t=r[i],n[t]=null,delete n[t];return n},DROP:function(){return this.drop.apply(this,arguments)},modify:function(){}}},ALTER_TABLE:function(t){return this.alterTable.call(this,t)},insertInto:function(t){var n=this[t];return function(){var t=s.apply({},arguments),e=function(){var r,i,u=Array.from(arguments),s=0,o=t.length;for(s;o>s;++s)r=t[s],n[r].push(u[s]);for(i in n)n.hasOwnProperty(i)&&-1===t.indexOf(i)&&n[i].push(void 0);return e};return{values:e,VALUES:e}}},INSERT_INTO:function(t){return this.insertInto.call(this,t)},insertJsonInto:function(t){var n=this[t],e=this;return function(t){var r,i,u,s,o,a=0,c=t.length,h=n._event.substr(n._event.indexOf(".")+1),f=e.insertInto(h);for(a;c>a;++a){i=t[a],u=[],o=[];for(r in i)i.hasOwnProperty(r)&&(n[r]||e.alterTable(h).add(r),u.push(r),o.push(i[r]));s=f.apply(null,u),s.values.apply(null,o)}}},INSERT_JSON_INTO:function(t){this.insertJsonInto.call(this,t)},update:function(t){var n=this[t],e={},r=function(t,n){return e[t]=n,r};return r.WHERE=r.where=function(t,r,i){var u=new o(n,t,r,i);return u.GO=u.go=function(){var t,r,i=0,u=this.validIndices.length;for(i;u>i;++i){t=this.validIndices[i];for(r in n)n.hasOwnProperty(r)&&e[r]&&(n[r][t]=e[r])}return!0},u},{set:r,SET:r}},UPDATE:function(t){return this.update.call(this,t)},"delete":function(){var t,n=s.apply({},arguments),e=this,r=function(r){return t=e[r],(0===n.length||"*"===n[0])&&(n=t.columns()),{where:u,WHERE:u,go:i,GO:i}},i=function(){var e,r,i,u,s=this.validIndices,o=0,a=n.length;for(void 0===s&&(s=t.indices()),e=s.length;e>o;++o)for(r=s[o],i=0;a>i;++i)u=t[n[i]],u.insert(null,r);return!0},u=function(n,e,r){var u=new o(t,n,e,r);return u.GO=u.go=i.bind(u),u};return{from:r,FROM:r}},DELETE:function(){return this["delete"].apply(this,arguments)}},{createDB:u.create,CREATE_DATABASE:u.create,dropDB:u.drop,DROP_DATABASE:u.drop,use:u.get,USE:u.get,show:u.show,SHOW_DATABASES:u.show}});